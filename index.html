<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Old Work Orders</title>
<style>
  :root{--bg:#0b0d12;--panel:#0f1423;--card:#121726;--muted:#9db0c9;--text:#e8f0ff;--accent:#4da3ff;--border:#22314d}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .app{display:flex;flex-direction:column;height:100%}
  header{padding:12px 16px;border-bottom:1px solid var(--border);background:var(--panel);position:sticky;top:0;z-index:10}
  h1{margin:0;font-size:18px}
  .searchbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  input[type="search"],input[type="text"]{flex:1;min-width:200px;padding:10px 12px;border-radius:8px;border:1px solid var(--border);background:#0b1322;color:var(--text)}
  .meta{font-size:12px;color:var(--muted);margin-top:6px}

  main{display:flex;flex:1;min-height:0}
  .list{width:420px;max-width:100%;border-right:1px solid var(--border);overflow:auto}
  .row{padding:10px 14px;border-bottom:1px solid var(--border);cursor:pointer}
  .row:hover{background:#0e1626}
  .row.active{background:#11213a;border-left:3px solid var(--accent)}
  .addrOnly{color:var(--text);font-weight:700}
  .subaddr{color:var(--muted);font-size:12px;margin-top:2px}

  .detail{flex:1;overflow:auto;padding:16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px}
  .bigaddr{font-size:22px;font-weight:800;margin-bottom:8px}
  .infoRow{font-size:15px;margin-bottom:8px;color:#cfe1ff}
  .infoRow .tag{margin-right:14px}
  .tag strong{font-weight:700}
  .locRow{font-size:14px;color:#bcd6ff}

  .section{margin-top:14px}
  .section h3{margin:0 0 8px 0;font-size:12px;text-transform:uppercase;letter-spacing:.6px;color:var(--muted)}

  .problem{background:#1a243d;border:1px solid var(--border);border-radius:10px;padding:12px}
  .problem .label{color:#ffd28c;font-size:12px;text-transform:uppercase;letter-spacing:.5px}
  .problem .value{margin-top:6px;white-space:pre-wrap}

  .notes{background:#171f33;border:1px solid var(--border);border-radius:10px;padding:12px}
  .notes .label{color:#a7ffcf;font-size:12px;text-transform:uppercase;letter-spacing:.5px}
  .notes .value{margin-top:6px;white-space:pre-wrap}
  .notes .line{margin-top:8px}
  .notes .line .label{color:var(--muted);font-size:12px}
  .notes .line .value{margin-top:4px}

  .parts .group{margin-top:10px}
  .parts .group h4{margin:0 0 6px 0;font-size:12px;text-transform:uppercase;letter-spacing:.5px;color:#b2c8ff}
  .parts .list{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:8px;width:100%;max-width:100%}
  .parts .item{background:#0f1629;border:1px solid var(--border);border-radius:8px;padding:8px}
  .parts .item .label{color:var(--muted);font-size:12px}
  .parts .item .value{margin-top:4px}


  /* Mobile fix: ensure parts items render inside fixed detail pane */
  .parts .list{
    overflow:visible;
  }

  /* Mobile fullscreen behaviour via JS sets inline styles; this media rule only hides list when class is set */
  @media (max-width: 900px){
    .list{width:100%;max-width:none}
    main{flex-direction:column}
    .app.mobile-detail > main > .list{display:none}
  }

  /* Back button shown only in mobile-detail mode */
  .backbar{display:none;margin:0 0 10px 0}
  .app.mobile-detail .backbar{display:block}
  .backbtn{display:inline-flex;align-items:center;gap:8px;background:#0e1629;color:#eaf2ff;border:1px solid var(--border);border-radius:8px;padding:8px 12px;cursor:pointer}
  .backbtn:hover{background:#12203a}
</style>
</head>
<body>
<div class="app" id="app">
  <header id="hdr">
    <h1>Old Work Orders</h1>
    <div class="searchbar">
      <input id="q" type="search" placeholder="Phrase search (exact words in order, e.g., 200 W). Fielded: HOUSE NO:200 STREET NAME:W" />
         </div>
    <div class="meta"><span id="meta">Loading…</span> <span id="msg" style="color:#ff9e9e"></span></div>
  </header>

  <main>
    <div class="list" id="list"></div>
    <div class="detail" id="detailPane">
      <div class="backbar"><button class="backbtn" id="backBtn">◀ Back to results</button></div>
      <div class="card" id="detail">Select a record…</div>
    </div>
  </main>
</div>

<script>
(function(){
  window.addEventListener('error', function(e){
    var el = document.getElementById('msg');
    if(el) el.textContent = 'Runtime error: ' + (e.message||e.error||'unknown');
  });
})();

(async function(){
  const $ = (id)=>document.getElementById(id);
  const app=$('app');
  const hdr=$('hdr');
  const meta=$('meta'), msg=$('msg'), listEl=$('list'), detailEl=$('detail'), q=$('q'), adv=$('adv');
  const detailPane=$('detailPane');
  const backBtn=$('backBtn');
  const esc = (s)=> (s||'').toString().replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
  const norm = (s)=> (s||'').toString().toLowerCase();
  const squeeze = (s)=> norm(s).replace(/\s+/g,' ').trim();
  const isMobile = ()=> window.matchMedia('(max-width: 900px)').matches;

  // Load JSON
  let columns=[], records=[], listFields=[], addressFields=[], payload;
  try{
    const r = await fetch('data.json', {cache:'no-store'});
    if(!r.ok) throw new Error('HTTP '+r.status+' '+r.statusText);
    payload = await r.json();
    columns = payload.columns||[];
    records = payload.records||[];
    listFields = payload.listFields||[];
    addressFields = payload.addressFields||[];
    meta.textContent = `${records.length} records | ${columns.length} fields`;
  }catch(e){ meta.textContent='0 records'; msg.textContent='Failed to load data.json — '+e.message; return; }

  const getCol = (name)=> columns.find(c=>c.toLowerCase()===name.toLowerCase());
  const colAddress = getCol('ADDRESS');
  const colWO = (function(){ const preferred=['WORK_ORDER NO','WORK ORDER NO','WORK_ORDER','WORK ORDER','WO','WORKORDER']; for(const p of preferred){ const c=getCol(p); if(c) return c; } return null; })();
  const colDate   = getCol('DATE');
  const colName   = getCol('NAME');
  const colHouse  = getCol('HOUSE NO');
  const colStreet = getCol('STREET NAME');
  const colApprox = getCol('APPROX ADDRESS');
  const colProblem= (function(){ const p=['PROBLEM','DESCRIPTION']; for(const n of p){const c=getCol(n); if(c) return c;} return null; })();
  const colNotes  = getCol('NOTES');
  const colML     = getCol('ML MEASUREMENTS');
  const colDblOff = getCol('DBL OFF OF');
  const colDblWith= getCol('DBL WITH');

  function displayAddress(rec){
    const a = colAddress? rec[colAddress] : '';
    if(a) return a;
    const hn = colHouse? rec[colHouse] : '';
    const st = colStreet? rec[colStreet] : '';
    return (hn||'') + (hn&&st?' ':'') + (st||'');
  }

  function formatMDY(s){
    if(!s) return '';
    const t = s.toString().split(/[T\s]/)[0];
    let d = new Date(s);
    if(isNaN(d)){
      const m = t.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{2,4})/);
      if(m){ d = new Date(m[3].length===2?('20'+m[3]):m[3], parseInt(m[1],10)-1, parseInt(m[2],10)); }
    }
    if(!isNaN(d)){
      const mm=String(d.getMonth()+1).padStart(2,'0');
      const dd=String(d.getDate()).padStart(2,'0');
      const yy=d.getFullYear();
      return `${mm}-${dd}-${yy}`;
    }
    const sm = s.toString().match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{2,4})/);
    if(sm){ const mm=sm[1].padStart(2,'0'), dd=sm[2].padStart(2,'0'), yy=sm[3].length===2?('20'+sm[3]):sm[3]; return `${mm}-${dd}-${yy}`; }
    return s;
  }

  function buildPhraseRegex(phrase){
    const escRe = s=> s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const tokens = phrase.trim().split(/\s+/).map(escRe).filter(Boolean);
    if(!tokens.length) return null;
    const pattern = `\\b${tokens.join('\\s+')}\\b`;
    try{ return new RegExp(pattern, 'i'); }catch(e){ return null; }
  }

  function buildLabelMap(rec){
    const map={};
    for(const c of columns){
      if(c.length>1 && /[aA]$/.test(c)){
        const base=c.slice(0, -1).trim();
        if(columns.includes(base)){
          const v=(rec[c]||'').toString().trim();
          if(v) map[base]=v;
        }
      }
    }
    return map;
  }

  const partLabels = { A:{ 'A1':'1\" HD Coupling','A2':'1\" Corp','A3':'1\" Dresser','A4':'1\" M Valve','A5':'1\" F Valve','A6':'1\" M End','A7':'1\" F End','A8':'1\" Pipe' }, B:{}, C:{}, D:{}, E:{ 'E1':'4\" Brass Saddle','E2':'4\" Pipe','E3':'6\" Brass Saddle','E4':'6\" Pipe','E5':'8\" Brass Saddle','E6':'8\" Pipe','E7':'1\" AirVac','E8':'2\" AirVac' } };
  const Adefs=['HD Coupling','Corp','Dresser','M Valve','F Valve','M End','F End','Pipe'];
  const sizes={B:'1.25',C:'1.5',D:'2'};
  for(const grp of ['B','C','D']){ Adefs.forEach((label,idx)=>{ partLabels[grp][grp+(idx+1)] = `${sizes[grp]}\" ${label}`; }); }
  partLabels.D['D9'] = '2.5\" HD Coupling';

  function matches(rec){
    const phrase = squeeze(q.value);
    const advStr = adv.value.trim();
    const allTokens = (advStr + ' ' + q.value).trim().split(/\s+/).filter(t=>t.includes(':'));

    for(const t of allTokens){
      const [fieldRaw, ...rest] = t.split(':');
      const value = rest.join(':');
      const col = columns.find(c=>c.toLowerCase()===fieldRaw.toLowerCase());
      if(!col) return false;
      if(!norm(rec[col]).includes(norm(value))) return false;
    }

    if(phrase){
      const hay = squeeze([displayAddress(rec), colWO?rec[colWO]:'', ...addressFields.map(f=>rec[f]||''), ...listFields.map(f=>rec[f]||'')].join(' '));
      const rx = buildPhraseRegex(phrase);
      if(!rx || !rx.test(hay)) return false;
    }
    return true;
  }

  // Declare ONCE
  let filtered = records;
  let activeIndex = -1;

  function renderList(){
    listEl.innerHTML='';
    filtered.forEach((r,i)=>{
      const row=document.createElement('div');
      row.className='row'+(i===activeIndex?' active':'');
      const addr = displayAddress(r)||'(no address)';
      const hn = colHouse? r[colHouse] : '';
      const st = colStreet? r[colStreet] : '';
      const ap = colApprox? r[colApprox] : '';
      const subParts = [hn?`House: ${hn}`:'', st?`Street: ${st}`:'', ap?`Approx: ${ap}`:''].filter(Boolean).join(' · ');
      row.innerHTML=`<div class=addrOnly>${esc(addr)}</div>` + (subParts?`<div class=subaddr>${esc(subParts)}</div>`:'');
      row.onclick=()=>{
        activeIndex=i; renderDetail(r); renderList();
        if(isMobile()){
          try{ q.blur(); adv.blur && adv.blur(); }catch(e){}
          // Enter fullscreen detail: fix the pane over content beneath header
          const h = hdr ? hdr.offsetHeight : 0;
          app.classList.add('mobile-detail');
          Object.assign(detailPane.style, {
            position:'fixed', top: h+'px', left:'0', right:'0', bottom:'0',
            width:'100%', background:getComputedStyle(document.body).backgroundColor,
            overflowY:'auto', WebkitOverflowScrolling:'touch'
          });
          detailPane.scrollTop = 0;
        }
      };
      listEl.appendChild(row);
    });
  }

  function exitMobileDetail(){
    app.classList.remove('mobile-detail');
    detailPane.removeAttribute('style');
    // scroll list back to top so user sees results again
    listEl.scrollTop = 0;
    window.scrollTo({top:0,behavior:'smooth'});
  }
  if(backBtn){ backBtn.addEventListener('click', exitMobileDetail); }

  function renderDetail(rec){
    const lbl=buildLabelMap(rec);

    const bigAddr = esc(displayAddress(rec)||'');
    const woStr   = (colWO && rec[colWO])   ? `<span class=\"tag\"><strong>WO:</strong> ${esc(rec[colWO])}</span>` : '';
    const dateStr = (colDate && rec[colDate])? `<span class=\"tag\"><strong>Date:</strong> ${esc(formatMDY(rec[colDate]))}</span>` : '';
    const nameStr = (colName && rec[colName])? `<span class=\"tag\"><strong>Name:</strong> ${esc(rec[colName])}</span>` : '';

    const locTags=[];
    if(colHouse && rec[colHouse])  locTags.push(`<span class=\"tag\"><strong>${esc(lbl[colHouse]||'House No')}:</strong> ${esc(rec[colHouse])}</span>`);
    if(colStreet && rec[colStreet])locTags.push(`<span class=\"tag\"><strong>${esc(lbl[colStreet]||'Street Name')}:</strong> ${esc(rec[colStreet])}</span>`);
    if(colApprox && rec[colApprox])locTags.push(`<span class=\"tag\"><strong>${esc(lbl[colApprox]||'Approx Address')}:</strong> ${esc(rec[colApprox])}</span>`);
    const locationRow = locTags.length? `<div class=\"infoRow locRow\">${locTags.join('')}</div>` : '';

    let problemBlock='';
    if(colProblem && rec[colProblem]){
      problemBlock = `<div class=\"section\"><div class=problem><div class=label>Problem</div><div class=value>${esc(rec[colProblem])}</div></div></div>`;
    }

    const noteLines=[];
    if(colNotes && rec[colNotes])  noteLines.push({label:'Notes', value:rec[colNotes]});
    if(colML && rec[colML])        noteLines.push({label:'ML Measurements', value:rec[colML]});
    if(colDblOff && rec[colDblOff])noteLines.push({label:'Double Off Of', value:rec[colDblOff]});
    if(colDblWith && rec[colDblWith])noteLines.push({label:'Double With', value:rec[colDblWith]});
    let notesBlock='';
    if(noteLines.length){
      notesBlock = `<div class=\"section\"><h3>Notes</h3><div class=notes>${noteLines.map(x=>`<div class=line><div class=label>${esc(x.label)}</div><div class=value>${esc(x.value)}</div></div>`).join('')}</div></div>`;
    }

    function getCol(name){ return columns.find(c=>c.toLowerCase()===name.toLowerCase()); }
    function buildPartGroup(letter){
      const defs = partLabels[letter] || {};
      const items=[];
      for(const key of Object.keys(defs)){
        const col = getCol(key);
        if(!col) continue;
        const v=(rec[col]||'').toString().trim();
        if(!v) continue;
        items.push({label:defs[key], value:v});
      }
      return items;
    }

    const partsA = buildPartGroup('A');
    const partsB = buildPartGroup('B');
    const partsC = buildPartGroup('C');
    const partsD = buildPartGroup('D');
    const partsE = buildPartGroup('E');

    function partsGroupHtml(title, items){ if(!items.length) return ''; return `<div class=\"group\"><h4>${esc(title)}</h4><div class=list>${items.map(x=>`<div class=item><div class=label>${esc(x.label)}</div><div class=value>${esc(x.value)}</div></div>`).join('')}</div></div>`; }

    let partsBlock='';
    const groupsHtml = [
      partsGroupHtml('1\" Parts', partsA),
      partsGroupHtml('1.25\" Parts', partsB),
      partsGroupHtml('1.5\" Parts', partsC),
      partsGroupHtml('2\" / 2.5\" Parts', partsD),
      partsGroupHtml('Large Parts', partsE)
    ].join('');
    if(groupsHtml) partsBlock = `<div class=\"section parts\"><h3>Materials</h3>${groupsHtml}</div>`;

    const miscItems=[]; for(const c of columns){ if(/^misc\d*$/i.test(c)){ const v=(rec[c]||'').toString().trim(); if(!v) continue; const label = (rec[c+'A']||'').toString().trim() || c; miscItems.push({label, value:v}); } }
    let miscBlock=''; if(miscItems.length){ miscBlock = `<div class=\"section\"><h3>Miscellaneous</h3><div class=notes>${miscItems.map(x=>`<div class=line><div class=label>${esc(x.label)}</div><div class=value>${esc(x.value)}</div></div>`).join('')}</div></div>`; }

    detailEl.innerHTML = `<div class=card>
      <div class=bigaddr>${bigAddr}</div>
      <div class=infoRow>${woStr}${dateStr}${nameStr}</div>
      ${locationRow}
      ${problemBlock}
      ${notesBlock}
      ${partsBlock}
      ${miscBlock}
    </div>`;
  }

  function renderAll(){
    filtered = records.filter(matches);
    meta.textContent = `${filtered.length} match${filtered.length===1?'':'es'} of ${records.length}`;
    renderList();
    if(filtered.length){ if(activeIndex===-1) activeIndex=0; renderDetail(filtered[activeIndex]); } else { detailEl.innerHTML='<div class="card">No matches.</div>'; activeIndex=-1; }
  }

  q.addEventListener('input', ()=>{ if(app.classList.contains('mobile-detail')){ /* leave detail mode when typing */ app.classList.remove('mobile-detail'); detailPane.removeAttribute('style'); } renderAll(); });
  adv.addEventListener('input', ()=>{ if(app.classList.contains('mobile-detail')){ app.classList.remove('mobile-detail'); detailPane.removeAttribute('style'); } renderAll(); });

  renderAll();
})();
</script>
</body>
</html>
