<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Work Orders — Approach‑Style Viewer v4 (mobile fullscreen)</title>
<style>
  :root{--bg:#0b0d12;--panel:#0f1423;--card:#121726;--muted:#9db0c9;--text:#e8f0ff;--accent:#4da3ff;--border:#22314d}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .app{display:flex;flex-direction:column;height:100%}
  header{padding:12px 16px;border-bottom:1px solid var(--border);background:var(--panel);position:sticky;top:0;z-index:10}
  h1{margin:0;font-size:18px}
  .searchbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  input[type="search"],input[type="text"]{flex:1;min-width:200px;padding:10px 12px;border-radius:8px;border:1px solid var(--border);background:#0b1322;color:var(--text)}
  .meta{font-size:12px;color:var(--muted);margin-top:6px}

  main{display:flex;flex:1;min-height:0}
  .list{width:420px;max-width:100%;border-right:1px solid var(--border);overflow:auto}
  .row{padding:10px 14px;border-bottom:1px solid var(--border);cursor:pointer}
  .row:hover{background:#0e1626}
  .row.active{background:#11213a;border-left:3px solid var(--accent)}
  .addrOnly{color:var(--text);font-weight:700}
  .subaddr{color:var(--muted);font-size:12px;margin-top:2px}

  .detail{flex:1;overflow:auto;padding:16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px}
  .bigaddr{font-size:22px;font-weight:800;margin-bottom:8px}
  .infoRow{font-size:15px;margin-bottom:8px;color:#cfe1ff}
  .infoRow .tag{margin-right:14px}
  .tag strong{font-weight:700}
  .locRow{font-size:14px;color:#bcd6ff}

  .section{margin-top:14px}
  .section h3{margin:0 0 8px 0;font-size:12px;text-transform:uppercase;letter-spacing:.6px;color:var(--muted)}

  .problem{background:#1a243d;border:1px solid var(--border);border-radius:10px;padding:12px}
  .problem .label{color:#ffd28c;font-size:12px;text-transform:uppercase;letter-spacing:.5px}
  .problem .value{margin-top:6px;white-space:pre-wrap}

  .notes{background:#171f33;border:1px solid var(--border);border-radius:10px;padding:12px}
  .notes .label{color:#a7ffcf;font-size:12px;text-transform:uppercase;letter-spacing:.5px}
  .notes .value{margin-top:6px;white-space:pre-wrap}
  .notes .line{margin-top:8px}
  .notes .line .label{color:var(--muted);font-size:12px}
  .notes .line .value{margin-top:4px}

  .parts .group{margin-top:10px}
  .parts .group h4{margin:0 0 6px 0;font-size:12px;text-transform:uppercase;letter-spacing:.5px;color:#b2c8ff}
  .parts .list{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:8px}
  .parts .item{background:#0f1629;border:1px solid var(--border);border-radius:8px;padding:8px}
  .parts .item .label{color:var(--muted);font-size:12px}
  .parts .item .value{margin-top:4px}

  @media (max-width: 900px){
    .list{width:100%;max-width:none}
    main{flex-direction:column}
    .app.mobile-detail .list{display:none}
    /* Only allow the materials section to be visible on mobile */
    .section.parts, .section { display: block !important; }
  }

  .backbar{display:none;margin:0 0 10px 0}
  .app.mobile-detail .backbar{display:block}
  .backbtn{display:inline-flex;align-items:center;gap:8px;background:#0e1629;color:#eaf2ff;border:1px solid var(--border);border-radius:8px;padding:8px 12px;cursor:pointer}
</style>
</head>
<body>
<div class="app" id="app">
  <header id="hdr">
    <h1>Work Orders — Approach‑Style Viewer</h1>
    <div class="searchbar">
      <input id="q" type="search" placeholder="Phrase search..." />
      <input id="adv" type="text" placeholder="Optional fielded terms..." />
    </div>
    <div class="meta"><span id="meta">Loading…</span> <span id="msg" style="color:#ff9e9e"></span></div>
  </header>

  <main>
    <div class="list" id="list"></div>
    <div class="detail" id="detailPane">
      <div class="backbar"><button class="backbtn" id="backBtn">◀ Back to results</button></div>
      <div class="card" id="detail">Select a record…</div>
    </div>
  </main>
</div>

<script>
(async function(){
  const $ = (id)=>document.getElementById(id);
  const app=$('app'), hdr=$('hdr'), meta=$('meta'), msg=$('msg'), listEl=$('list'), detailEl=$('detail'), q=$('q'), adv=$('adv'), detailPane=$('detailPane'), backBtn=$('backBtn');
  const esc = (s)=> (s||'').toString().replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
  const norm = (s)=> (s||'').toString().toLowerCase();
  const squeeze = (s)=> norm(s).replace(/\s+/g,' ').trim();
  const isMobile = ()=> window.matchMedia('(max-width: 900px)').matches;

  let columns=[], records=[], payload;
  try {
    const r = await fetch('data.json', {cache:'no-store'});
    payload = await r.json();
    columns = payload.columns||[];
    records = payload.records||[];
    meta.textContent = `${records.length} records`;
  } catch(e) { meta.textContent='0 records'; return; }

  const getCol = (name)=> columns.find(c=>c.toLowerCase()===name.toLowerCase());
  const colAddress = getCol('ADDRESS'), colWO = getCol('WORK_ORDER NO'), colDate = getCol('DATE');
  const colProblem = getCol('PROBLEM'), colNotes = getCol('NOTES');

  const partLabels = { A:{'A1':'1\" HD Coupling','A2':'1\" Corp','A3':'1\" Dresser','A4':'1\" M Valve','A5':'1\" F Valve','A6':'1\" M End','A7':'1\" F End','A8':'1\" Pipe'}, E:{'E1':'4\" Brass Saddle','E2':'4\" Pipe','E3':'6\" Brass Saddle','E4':'6\" Pipe','E5':'8\" Brass Saddle','E6':'8\" Pipe','E7':'1\" AirVac','E8':'2\" AirVac'} };
  ['B','C','D'].forEach(g=>{ partLabels[g]={}; const sz=g==='B'?'1.25':g==='C'?'1.5':'2'; ['HD Coupling','Corp','Dresser','M Valve','F Valve','M End','F End','Pipe'].forEach((l,i)=>{partLabels[g][g+(i+1)]=`${sz}\" ${l}`})});

  function matches(rec){
    const s = squeeze(q.value);
    if(!s) return true;
    return squeeze([rec[colAddress]||'', rec[colWO]||''].join(' ')).includes(s);
  }

  let filtered = records, activeIndex = -1;

  function renderList(){
    listEl.innerHTML='';
    filtered.forEach((r,i)=>{
      const row=document.createElement('div');
      row.className='row'+(i===activeIndex?' active':'');
      row.innerHTML=`<div class=addrOnly>${esc(r[colAddress]||'No Address')}</div><div class=subaddr>WO #${r[colWO]||'N/A'}</div>`;
      row.onclick=()=>{
        activeIndex=i; renderDetail(r); renderList();
        if(isMobile()){
          app.classList.add('mobile-detail');
          Object.assign(detailPane.style, { position:'fixed', top:hdr.offsetHeight+'px', left:'0', right:'0', bottom:'0', background:getComputedStyle(document.body).backgroundColor, overflowY:'auto' });
          detailPane.scrollTop = 0;
        }
      };
      listEl.appendChild(row);
    });
  }

  function renderDetail(rec){
    // Helper to hide empty/N/A values on mobile
    const isVal = (v) => v && v !== "0" && v !== "" && v !== "N/A" && v !== "NaT";

    const partsHtml = ['A','B','C','D','E'].map(l=>{
      const items = [];
      const defs = partLabels[l] || {};
      for(const k in defs){
        const c = getCol(k);
        if(c && isVal(rec[c])) items.push(`<div class=item><div class=label>${esc(defs[k])}</div><div class=value>${esc(rec[c])}</div></div>`);
      }
      return items.length ? `<div class="group"><h4>${l} Group</h4><div class=list>${items.join('')}</div></div>` : '';
    }).join('');

    detailEl.innerHTML = `<div class=card>
      <div class=bigaddr>${esc(rec[colAddress]||'')}</div>
      <div class=infoRow><span class=tag><strong>WO:</strong> ${esc(rec[colWO]||'')}</span></div>
      ${isVal(rec[colProblem]) ? `<div class="section"><div class=problem><div class=label>Problem</div><div class=value>${esc(rec[colProblem])}</div></div></div>` : ''}
      ${partsHtml ? `<div class="section parts"><h3>Materials</h3>${partsHtml}</div>` : ''}
    </div>`;
  }

  backBtn.onclick = () => { app.classList.remove('mobile-detail'); detailPane.removeAttribute('style'); };
  q.oninput = () => { filtered = records.filter(matches); renderList(); if(filtered.length) renderDetail(filtered[0]); };
  renderList(); if(filtered.length) renderDetail(filtered[0]);
})();
</script>
</body>
</html>